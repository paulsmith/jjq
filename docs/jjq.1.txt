  JJQ(1)                      General Commands Manual                     JJQ(1)

  NAME
         jjq - local merge queue for jj

  SYNOPSIS
         jjq push <revset>
         jjq run [--all] [--stop-on-failure]
         jjq check [--rev <revset>] [-v]
         jjq status
         jjq delete <id>
         jjq clean
         jjq doctor
         jjq config [<key> [<value>]]

  DESCRIPTION
         jjq is a local merge queue for jj (Jujutsu VCS). It queues revisions
         for merging to a trunk bookmark, processes them in FIFO order, and
         gates each merge on a configurable check command. This prevents the
         "works on my branch" problem where changes pass checks individually
         but fail when combined with concurrent work.

         jjq stores all state inside the jj repository using bookmarks and an
         isolated metadata branch. No external database or service is required.

  COMMANDS
     push <revset>
         Queue a revision for merging to trunk. The revset must resolve to
         exactly one revision.

         Before queuing, jjq creates a temporary merge commit between the
         trunk and the candidate to check for textual conflicts. If conflicts
         are detected, the push is rejected with exit code 1.

         Push is idempotent for the same change ID: if the change is already
         queued or failed, the stale entry is cleared and the revision is
         re-queued. However, if the same change ID is already queued at a
         different commit ID (i.e., the revision has been amended), the push
         is rejected with exit code 10.

         Examples:
             jjq push @              Queue the working copy revision
             jjq push feat-xyz@      Queue a workspace's working copy
             jjq push abc123         Queue by change ID

     run [--all] [--stop-on-failure]
         Process the next queued item. Creates a temporary jj workspace with
         two parents (trunk and candidate), then runs the configured check
         command inside it.

         On success, the trunk bookmark advances to the merge commit and
         the temporary workspace is cleaned up.

         On failure (conflicts or check command failure), the item moves to
         the failed list. The temporary workspace is preserved for debugging.

         If the trunk bookmark moves during processing (e.g., another runner
         advanced it), the run aborts and instructs the user to retry.

         With --all, processes items in a loop until the queue is empty.
         Failed items are moved to the failed list and processing continues
         with the next item. Reports the count of successes and failures.

         With --all --stop-on-failure, stops at the first failure instead
         of continuing.

         Returns 0 if all items merged successfully (or the queue was empty).
         Returns 1 if --stop-on-failure is set and an item fails. Returns 2
         if some items succeeded and some failed.

     check [--rev <revset>] [-v]
         Run the configured check command against a revision in a temporary
         workspace without any queue processing. Useful for verifying that
         the check command works before queuing items.

         Defaults to the current working copy (@) if --rev is not specified.

         With -v (--verbose), prints the workspace path, shell, and all
         environment variables before running the check command. Useful for
         diagnosing path or environment issues.

         The temporary workspace is always cleaned up, regardless of
         outcome. Exits 0 if the check passes; 1 if it fails.

     status
         Display the current queue state: queued items (ascending by sequence
         ID) and recent failures (descending, up to max_failures). Each entry
         shows its sequence ID, change ID prefix, and first line of the
         commit description.

         Also indicates if a run lock is currently held (another jjq run is
         in progress).

     delete <id>
         Remove an item from the queue or the failed list by its sequence ID.
         The sequence ID is the number shown in status output and push
         confirmation messages.

     clean
         Remove jjq workspaces left behind by failed merges. Lists each
         workspace removed. Safe to run at any time -- only removes jjq-owned
         workspaces, never user workspaces.

     doctor
         Validate that the jjq environment is correctly configured.
         Checks the trunk bookmark, check command, lock state, and
         workspace preconditions. Each check is reported as ok, WARN,
         or FAIL. When a check fails, a suggested fix is shown.

         Exits 0 if no failures are found (warnings are tolerated).
         Exits 1 if any check fails.

     config [<key> [<value>]]
         Get or set configuration. With no arguments, displays all
         configuration values. With one argument, displays that key's value.
         With two arguments, sets the key to the given value.

         Valid keys:

         trunk_bookmark (default: "main")
             The bookmark that jjq treats as the protected trunk. All merges
             target this bookmark.

         check_command (required)
             Shell command to run in the merge workspace to validate a
             candidate. Should run tests, lints, type checks, or whatever
             gates your trunk. Exit 0 means pass; non-zero means fail.

             Must be configured before running jjq push or jjq run.

         max_failures (default: 3)
             Number of recent failures shown by status.

  EXIT CODES
         0    Success.

         1    Merge conflict or check command failure.

         2    Partial success. Some items merged, some failed (run --all
              without --stop-on-failure).

         3    Lock held. Another jjq process is running. Retry later.

         10   Usage error. Bad arguments, ambiguous revset, duplicate push
              of an amended revision, etc.

  CONFIGURATION
         jjq stores configuration on an isolated metadata branch (jjq/_/_)
         parented to the repository root. This branch never appears in normal
         jj log output and does not pollute user history.

         Always configure check_command before using jjq run.

  LOCKING
         jjq uses filesystem-based locks (atomic mkdir) in .jj/jjq-locks/
         to coordinate concurrent access:

         id     Protects sequence ID allocation (brief, during push).

         config Protects configuration reads and writes.

         run    Ensures only one jjq run processes the queue at a time.

         If a lock is stale (e.g., from a crashed process), delete the
         corresponding directory under .jj/jjq-locks/.

  DATA MODEL
         Queue items are jj bookmarks named jjq/queue/NNNNNN where NNNNNN
         is a zero-padded sequence ID. Failed items use jjq/failed/NNNNNN.
         The metadata branch at jjq/_/_ stores the last allocated ID and
         all configuration.

         Successful merges are ordinary jj commits with two parents (trunk
         and candidate) and descriptions like "Success: merge N". Failed
         merges are preserved as conflicted commits with descriptions like
         "Failed: merge N (conflicts)".

  TYPICAL WORKFLOW
         Initialize a project:
             jjq config trunk_bookmark main
             jjq config check_command "make test && make lint"

         Developer queues work:
             jjq push @

         Process the queue:
             jjq run          # one item
             jjq run --all    # drain the queue

         Handle a failure:
             jjq status                    # see what failed
             jj rebase -r <rev> -d main    # rebase onto current trunk
             # ... resolve conflicts ...
             jjq push <rev>                # re-queue
             jjq run                       # retry

         Clean up:
             jjq clean         # remove failed merge workspaces

  ENVIRONMENT
         jjq must be run from within a jj repository. It invokes jj as a
         subprocess and expects it to be on PATH.

  TIPS
         o  Configure jj log to hide jjq metadata bookmarks:

                jj config set --repo 'revset-aliases."trunk()"' \
                    'main | ancestors(main, 2)'

         o  The check command runs in a temporary workspace that has the
            merged state of trunk + candidate. Any command that works in
            a normal checkout works here.

         o  Push is cheap. If you're unsure whether your revision will
            conflict, just push it -- jjq checks for conflicts up front
            and rejects the push if it would conflict.

         o  For parallel development with multiple agents or developers,
            use jj workspaces. Each workspace gets its own isolated working
            copy branched from trunk. Push from each workspace independently
            and let jjq serialize the merges.

  SEE ALSO
         jj(1)

  AUTHORS
         Paul Smith

  JJQ                              2026-02-03                             JJQ(1)